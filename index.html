<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canvas Lite - Fast LMS Client</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const BookOpen = () => (
      <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
      </svg>
    );

    const LogOut = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const ArrowLeft = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );

    function CanvasLite() {
      const [apiToken, setApiToken] = useState('');
      const [apiUrl, setApiUrl] = useState('https://canvas.instructure.com');
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [courses, setCourses] = useState([]);
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [assignments, setAssignments] = useState([]);
      const [selectedAssignment, setSelectedAssignment] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        const saved = {
          token: sessionStorage.getItem('canvas_token'),
          url: sessionStorage.getItem('canvas_url')
        };
        if (saved.token && saved.url) {
          setApiToken(saved.token);
          setApiUrl(saved.url);
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        if (isAuthenticated) fetchCourses();
      }, [isAuthenticated]);

      const fetchCourses = async () => {
        setLoading(true);
        setError('');
        try {
          const proxyUrl = 'https://corsproxy.io/?';
          const targetUrl = `${apiUrl}/api/v1/courses?enrollment_state=active&per_page=100`;
          const res = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
            headers: { Authorization: `Bearer ${apiToken}` }
          });
          if (!res.ok) throw new Error('Failed to fetch courses');
          const data = await res.json();
          setCourses(data);
        } catch (e) {
          setError(e.message);
        }
        setLoading(false);
      };

      const fetchCourseData = async (courseId) => {
        setLoading(true);
        setError('');
        try {
          const proxyUrl = 'https://corsproxy.io/?';
          const assignUrl = `${apiUrl}/api/v1/courses/${courseId}/assignments?per_page=100`;

          const assignRes = await fetch(proxyUrl + encodeURIComponent(assignUrl), {
            headers: { Authorization: `Bearer ${apiToken}` }
          });

          let assignData = assignRes.ok ? await assignRes.json() : [];

          // fetch full assignment details if missing description
          const enrichedAssignments = await Promise.all(assignData.map(async (a) => {
            if (a.description) return a;
            try {
              const detailUrl = `${apiUrl}/api/v1/courses/${courseId}/assignments/${a.id}`;
              const detailRes = await fetch(proxyUrl + encodeURIComponent(detailUrl), {
                headers: { Authorization: `Bearer ${apiToken}` }
              });
              if (detailRes.ok) {
                const detail = await detailRes.json();
                return { ...a, ...detail };
              }
            } catch (_) {}
            return a;
          }));

          setAssignments(enrichedAssignments);

          if (enrichedAssignments.length === 0) setError('No assignments or no access.');
        } catch (e) {
          setError('Failed to load course data: ' + e.message);
          setAssignments([]);
        }
        setLoading(false);
      };

      const handleLogin = () => {
        if (apiToken && apiUrl) {
          sessionStorage.setItem('canvas_token', apiToken);
          sessionStorage.setItem('canvas_url', apiUrl);
          setIsAuthenticated(true);
        }
      };

      const handleLogout = () => {
        sessionStorage.clear();
        setIsAuthenticated(false);
        setApiToken('');
        setCourses([]);
        setSelectedCourse(null);
        setAssignments([]);
      };

      const selectCourse = (course) => {
        setSelectedCourse(course);
        fetchCourseData(course.id);
      };

      const openAssignment = (a) => {
        setSelectedAssignment(a);
      };

      if (!isAuthenticated)
        return (
          <div className="flex flex-col items-center justify-center h-screen">
            <div className="p-6 bg-white rounded-xl shadow w-80 space-y-3">
              <h1 className="text-xl font-bold text-center">Canvas Lite</h1>
              <input
                type="text"
                className="border p-2 w-full rounded"
                placeholder="Canvas API Token"
                value={apiToken}
                onChange={(e) => setApiToken(e.target.value)}
              />
              <input
                type="text"
                className="border p-2 w-full rounded"
                placeholder="Canvas URL"
                value={apiUrl}
                onChange={(e) => setApiUrl(e.target.value)}
              />
              <button
                className="bg-blue-600 text-white p-2 rounded w-full"
                onClick={handleLogin}
              >
                Login
              </button>
            </div>
          </div>
        );

      if (loading)
        return (
          <div className="flex items-center justify-center h-screen text-lg">
            Loading...
          </div>
        );

      if (selectedAssignment)
        return (
          <div className="p-4">
            <button
              className="flex items-center gap-1 text-blue-600 mb-4"
              onClick={() => setSelectedAssignment(null)}
            >
              <ArrowLeft /> Back
            </button>
            <h1 className="text-2xl font-bold mb-2">{selectedAssignment.name}</h1>
            {selectedAssignment.description ? (
              <div
                className="prose"
                dangerouslySetInnerHTML={{ __html: selectedAssignment.description }}
              ></div>
            ) : (
              <p>No description (open in Canvas).</p>
            )}
            <a
              href={selectedAssignment.html_url}
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-600 underline mt-4 inline-block"
            >
              Open in Canvas
            </a>
          </div>
        );

      if (selectedCourse)
        return (
          <div className="p-4">
            <div className="flex justify-between items-center mb-4">
              <button
                className="flex items-center gap-1 text-blue-600"
                onClick={() => setSelectedCourse(null)}
              >
                <ArrowLeft /> Courses
              </button>
              <button
                className="flex items-center gap-1 text-red-600"
                onClick={handleLogout}
              >
                <LogOut /> Logout
              </button>
            </div>

            <h1 className="text-2xl font-bold mb-3">{selectedCourse.name}</h1>
            {error && <div className="text-red-600 mb-2">{error}</div>}
            <ul className="divide-y">
              {assignments.map((a) => (
                <li
                  key={a.id}
                  className="p-3 hover:bg-gray-100 cursor-pointer"
                  onClick={() => openAssignment(a)}
                >
                  {a.name}
                </li>
              ))}
            </ul>
          </div>
        );

      return (
        <div className="p-4">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <BookOpen /> Courses
            </h1>
            <button
              className="flex items-center gap-1 text-red-600"
              onClick={handleLogout}
            >
              <LogOut /> Logout
            </button>
          </div>
          {error && <div className="text-red-600 mb-2">{error}</div>}
          <ul className="divide-y">
            {courses.map((c) => (
              <li
                key={c.id}
                className="p-3 hover:bg-gray-100 cursor-pointer"
                onClick={() => selectCourse(c)}
              >
                {c.name}
              </li>
            ))}
          </ul>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<CanvasLite />);
  </script>
</body>
</html>
