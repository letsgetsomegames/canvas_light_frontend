<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas Lite - Fast LMS Client</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function CanvasLite() {
      const [apiToken, setApiToken] = useState('');
      const [apiUrl, setApiUrl] = useState('https://canvas.instructure.com');
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [courses, setCourses] = useState([]);
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [assignments, setAssignments] = useState([]);
      const [selectedAssignment, setSelectedAssignment] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      useEffect(() => {
        const token = sessionStorage.getItem('canvas_token');
        const url = sessionStorage.getItem('canvas_url');
        if (token && url) {
          setApiToken(token);
          setApiUrl(url);
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        if (isAuthenticated) fetchCourses();
      }, [isAuthenticated]);

      async function fetchCourses() {
        setLoading(true);
        setError('');
        try {
          const proxy = 'https://corsproxy.io/?';
          const res = await fetch(proxy + encodeURIComponent(`${apiUrl}/api/v1/courses?enrollment_state=active&per_page=100`), {
            headers: { 'Authorization': `Bearer ${apiToken}` }
          });
          if (!res.ok) throw new Error('Failed to fetch courses');
          const data = await res.json();
          setCourses(data);
        } catch (e) {
          setError(e.message);
        }
        setLoading(false);
      }

      async function fetchCourseAssignments(courseId) {
        setLoading(true);
        setError('');
        try {
          const proxy = 'https://corsproxy.io/?';
          const res = await fetch(proxy + encodeURIComponent(`${apiUrl}/api/v1/courses/${courseId}/assignments?per_page=100`), {
            headers: { 'Authorization': `Bearer ${apiToken}` }
          });
          if (!res.ok) throw new Error('Failed to fetch assignments');
          const data = await res.json();
          setAssignments(data);
        } catch (e) {
          setError(e.message);
        }
        setLoading(false);
      }

      async function fetchAssignmentDetails(courseId, assignmentId) {
        setLoading(true);
        setError('');
        try {
          const proxy = 'https://corsproxy.io/?';
          const res = await fetch(proxy + encodeURIComponent(`${apiUrl}/api/v1/courses/${courseId}/assignments/${assignmentId}`), {
            headers: { 'Authorization': `Bearer ${apiToken}` }
          });
          if (!res.ok) throw new Error('Failed to fetch assignment details');
          const data = await res.json();
          setSelectedAssignment(data);
        } catch (e) {
          setError(e.message);
        }
        setLoading(false);
      }

      function handleLogin() {
        if (!apiToken) return;
        sessionStorage.setItem('canvas_token', apiToken);
        sessionStorage.setItem('canvas_url', apiUrl);
        setIsAuthenticated(true);
      }

      function handleLogout() {
        sessionStorage.clear();
        setIsAuthenticated(false);
        setCourses([]);
        setAssignments([]);
        setSelectedCourse(null);
        setSelectedAssignment(null);
      }

      if (!isAuthenticated) {
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="bg-white p-6 rounded shadow-md space-y-4 w-80">
              <h2 className="text-lg font-semibold text-center">Canvas Lite Login</h2>
              <input type="text" placeholder="Canvas URL" value={apiUrl} onChange={e => setApiUrl(e.target.value)} className="w-full border p-2 rounded" />
              <input type="password" placeholder="API Token" value={apiToken} onChange={e => setApiToken(e.target.value)} className="w-full border p-2 rounded" />
              <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-2 rounded">Login</button>
            </div>
          </div>
        );
      }

      if (selectedAssignment) {
        return (
          <div className="p-4 space-y-4">
            <button onClick={() => setSelectedAssignment(null)} className="text-sm text-blue-600 underline">← Back</button>
            <h2 className="text-2xl font-bold">{selectedAssignment.name}</h2>

            {selectedAssignment.description ? (
              <div className="prose max-w-none" dangerouslySetInnerHTML={{ __html: selectedAssignment.description }}></div>
            ) : (
              <iframe
                src={selectedAssignment.html_url}
                width="100%"
                height="800"
                className="border rounded"
              ></iframe>
            )}

            <div>
              <a
                href={selectedAssignment.html_url}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-block mt-4 bg-blue-600 text-white px-4 py-2 rounded"
              >
                Open in Canvas
              </a>
            </div>
          </div>
        );
      }

      if (selectedCourse) {
        return (
          <div className="p-4 space-y-4">
            <div className="flex justify-between items-center">
              <button onClick={() => setSelectedCourse(null)} className="text-sm text-blue-600 underline">← Back to Courses</button>
              <button onClick={handleLogout} className="text-sm text-red-600 underline">Logout</button>
            </div>

            <h1 className="text-2xl font-bold">{selectedCourse.name}</h1>

            {loading && <p>Loading...</p>}
            {error && <p className="text-red-600">{error}</p>}

            <div className="space-y-2">
              {assignments.map(a => (
                <div key={a.id} onClick={() => fetchAssignmentDetails(selectedCourse.id, a.id)} className="p-3 bg-white border rounded cursor-pointer hover:bg-gray-100">
                  <p className="font-semibold">{a.name}</p>
                  <p className="text-sm text-gray-600">{a.due_at ? new Date(a.due_at).toLocaleString() : 'No due date'}</p>
                </div>
              ))}
            </div>
          </div>
        );
      }

      return (
        <div className="p-4 space-y-4">
          <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold">Your Courses</h1>
            <button onClick={handleLogout} className="text-sm text-red-600 underline">Logout</button>
          </div>

          {loading && <p>Loading...</p>}
          {error && <p className="text-red-600">{error}</p>}

          <div className="space-y-2">
            {courses.map(c => (
              <div key={c.id} onClick={() => { setSelectedCourse(c); fetchCourseAssignments(c.id); }} className="p-3 bg-white border rounded cursor-pointer hover:bg-gray-100">
                <p className="font-semibold">{c.name}</p>
                <p className="text-sm text-gray-600">{c.course_code}</p>
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<CanvasLite />);
  </script>
</body>
</html>
