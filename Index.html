<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Canvas Lite - Fixed</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const BookOpen = () => (
      <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
      </svg>
    );

    const LogOut = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const ArrowLeft = () => (
      <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );

    function CanvasLite() {
      const [apiToken, setApiToken] = useState('');
      const [apiUrl, setApiUrl] = useState('https://canvas.instructure.com');
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [courses, setCourses] = useState([]);
      const [selectedCourse, setSelectedCourse] = useState(null);
      const [assignments, setAssignments] = useState([]);
      const [selectedAssignment, setSelectedAssignment] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      // cache assignment details to avoid repeated failing fetches
      const detailsCache = useRef(new Map());

      useEffect(() => {
        const token = sessionStorage.getItem('canvas_token');
        const url = sessionStorage.getItem('canvas_url');
        if (token && url) {
          setApiToken(token);
          setApiUrl(url);
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        if (isAuthenticated) fetchCourses();
      }, [isAuthenticated]);

      const getCanvasBase = (url) => {
        try {
          const u = new URL(url);
          return u.origin;
        } catch (e) {
          // fallback to the raw string
          return url.replace(/\/+$/, '');
        }
      };

      const fetchCourses = async () => {
        setLoading(true);
        setError('');
        try {
          const proxyUrl = 'https://corsproxy.io/?';
          const targetUrl = `${apiUrl}/api/v1/courses?enrollment_state=active&per_page=100`;
          const res = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
            headers: { Authorization: `Bearer ${apiToken}` }
          });
          if (!res.ok) {
            const txt = await res.text().catch(() => '');
            throw new Error(`Failed to fetch courses (${res.status}) ${txt}`);
          }
          const data = await res.json();
          setCourses(Array.isArray(data) ? data : []);
        } catch (e) {
          console.error(e);
          setError('Failed to fetch courses: ' + e.message);
        } finally {
          setLoading(false);
        }
      };

      const fetchCourseData = async (courseId) => {
        setLoading(true);
        setError('');
        try {
          const proxyUrl = 'https://corsproxy.io/?';
          const assignUrl = `${apiUrl}/api/v1/courses/${courseId}/assignments?per_page=100`;
          const assignRes = await fetch(proxyUrl + encodeURIComponent(assignUrl), {
            headers: { Authorization: `Bearer ${apiToken}` }
          });

          let assignData = [];
          if (assignRes.ok) {
            assignData = await assignRes.json();
            if (!Array.isArray(assignData)) assignData = [];
          } else if (assignRes.status === 403) {
            setError('Access denied to assignments for this course (403).');
          } else {
            // non-OK, but still continue with empty array
            console.warn('Assignments fetch returned', assignRes.status);
          }

          // For each assignment missing description, we will try one detail fetch
          const enriched = await Promise.all(assignData.map(async (a) => {
            if (a.description) return a;
            const cacheKey = `${courseId}-${a.id}`;
            if (detailsCache.current.has(cacheKey)) {
              return detailsCache.current.get(cacheKey);
            }
            try {
              const detailUrl = `${apiUrl}/api/v1/courses/${courseId}/assignments/${a.id}`;
              const detailRes = await fetch(proxyUrl + encodeURIComponent(detailUrl), {
                headers: { Authorization: `Bearer ${apiToken}` }
              });
              if (detailRes.ok) {
                const detail = await detailRes.json();
                // store full detail even if description is empty, mark as fetched
                detailsCache.current.set(cacheKey, detail);
                return { ...a, ...detail };
              } else {
                // store a basic marker to avoid retrying repeatedly
                const marker = { ...a, __detailFetchFailed: true };
                detailsCache.current.set(cacheKey, marker);
                return marker;
              }
            } catch (e) {
              console.warn('detail fetch error', e);
              const marker = { ...a, __detailFetchFailed: true };
              detailsCache.current.set(cacheKey, marker);
              return marker;
            }
          }));

          setAssignments(Array.isArray(enriched) ? enriched : []);

          if ((!enriched || enriched.length === 0)) {
            if (!error) setError('No assignments or no access to assignments for this course.');
          }
        } catch (e) {
          console.error(e);
          setError('Failed to load course data: ' + e.message);
          setAssignments([]);
        } finally {
          setLoading(false);
        }
      };

      // fetch assignment details on demand, but use cache
      const fetchAssignmentDetails = async (courseId, assignmentId) => {
        const cacheKey = `${courseId}-${assignmentId}`;
        if (detailsCache.current.has(cacheKey)) {
          return detailsCache.current.get(cacheKey);
        }

        setLoading(true);
        try {
          const proxyUrl = 'https://corsproxy.io/?';
          const detailUrl = `${apiUrl}/api/v1/courses/${courseId}/assignments/${assignmentId}`;
          const res = await fetch(proxyUrl + encodeURIComponent(detailUrl), {
            headers: { Authorization: `Bearer ${apiToken}` }
          });
          if (!res.ok) {
            console.warn('Assignment detail fetch failed', res.status);
            const marker = { id: assignmentId, __detailFetchFailed: true };
            detailsCache.current.set(cacheKey, marker);
            return marker;
          }
          const detail = await res.json();
          detailsCache.current.set(cacheKey, detail);
          return detail;
        } catch (e) {
          console.warn('Assignment detail error', e);
          const marker = { id: assignmentId, __detailFetchFailed: true };
          detailsCache.current.set(cacheKey, marker);
          return marker;
        } finally {
          setLoading(false);
        }
      };

      const handleLogin = () => {
        if (!apiToken || !apiUrl) {
          setError('Token and URL required.');
          return;
        }
        sessionStorage.setItem('canvas_token', apiToken);
        sessionStorage.setItem('canvas_url', apiUrl);
        setIsAuthenticated(true);
      };

      const handleLogout = () => {
        sessionStorage.clear();
        setIsAuthenticated(false);
        setApiToken('');
        setCourses([]);
        setSelectedCourse(null);
        setAssignments([]);
        setSelectedAssignment(null);
        detailsCache.current.clear();
      };

      const selectCourse = (course) => {
        setSelectedCourse(course);
        setSelectedAssignment(null);
        setAssignments([]);
        setError('');
        fetchCourseData(course.id);
      };

      const openAssignment = async (a) => {
        setError('');
        const courseId = selectedCourse?.id;
        if (!courseId) {
          setSelectedAssignment(a);
          return;
        }

        // if object appears to already have description, use it
        if (a.description && typeof a.description === 'string') {
          setSelectedAssignment(a);
          return;
        }

        // try to fetch details (or read from cache)
        const details = await fetchAssignmentDetails(courseId, a.id);
        const merged = { ...a, ...(details || {}) };

        // if no description after fetch, mark noDescription flag
        if (!merged.description) {
          merged.noDescription = true;
          // build a sensible web URL fallback so user can open the assignment in Canvas UI
          const base = getCanvasBase(apiUrl);
          merged.web_url = merged.html_url || `${base}/courses/${courseId}/assignments/${a.id}`;
        }

        setSelectedAssignment(merged);
      };

      // UI
      if (!isAuthenticated) {
        return (
          <div className="flex items-center justify-center h-screen">
            <div className="p-6 bg-white rounded-xl shadow w-96 space-y-3">
              <h1 className="text-xl font-semibold text-center">Canvas Lite</h1>
              <input
                type="text"
                className="border p-2 w-full rounded"
                placeholder="Canvas API Token"
                value={apiToken}
                onChange={(e) => setApiToken(e.target.value)}
              />
              <input
                type="text"
                className="border p-2 w-full rounded"
                placeholder="Canvas base URL (e.g. https://canvas.instructure.com)"
                value={apiUrl}
                onChange={(e) => setApiUrl(e.target.value)}
              />
              <div className="flex gap-2">
                <button className="bg-blue-600 text-white p-2 rounded flex-1" onClick={handleLogin}>Login</button>
                <button className="bg-gray-200 p-2 rounded flex-1" onClick={() => { setApiUrl('https://canvas.instructure.com'); setApiToken(''); }}>Reset</button>
              </div>
              {error && <div className="text-red-600 text-sm">{error}</div>}
            </div>
          </div>
        );
      }

      if (loading) {
        return <div className="flex items-center justify-center h-screen text-lg">Loading...</div>;
      }

      if (selectedAssignment) {
        return (
          <div className="p-4">
            <div className="flex justify-between items-center mb-4">
              <button className="flex items-center gap-1 text-blue-600" onClick={() => setSelectedAssignment(null)}><ArrowLeft /> Back</button>
              <button className="flex items-center gap-1 text-red-600" onClick={handleLogout}><LogOut /> Logout</button>
            </div>

            <h1 className="text-2xl font-bold mb-2">{selectedAssignment.name || 'Assignment'}</h1>

            {selectedAssignment.description ? (
              <div className="prose" dangerouslySetInnerHTML={{ __html: selectedAssignment.description }}></div>
            ) : selectedAssignment.noDescription ? (
              <div className="space-y-2">
                <p className="text-sm text-gray-700">No description available for this assignment.</p>
                <p className="text-sm text-gray-600">Open in Canvas to view details or attachments.</p>
                <a className="text-blue-600 underline" href={selectedAssignment.web_url} target="_blank" rel="noopener noreferrer">Open in Canvas</a>
              </div>
            ) : selectedAssignment.__detailFetchFailed ? (
              <div className="space-y-2">
                <p className="text-sm text-gray-700">Could not fetch assignment details due to permission or CORS issues.</p>
                {selectedAssignment.html_url && <a className="text-blue-600 underline" href={selectedAssignment.html_url} target="_blank" rel="noopener noreferrer">Open in Canvas</a>}
              </div>
            ) : (
              <p className="text-sm text-gray-700">No description.</p>
            )}

            {/* show a few other fields if present */}
            <div className="mt-4 text-sm text-gray-700 space-y-1">
              {selectedAssignment.due_at && <div>Due: {new Date(selectedAssignment.due_at).toLocaleString()}</div>}
              {typeof selectedAssignment.points_possible !== 'undefined' && <div>Points: {selectedAssignment.points_possible}</div>}
              {selectedAssignment.submission_types && <div>Submission type: {Array.isArray(selectedAssignment.submission_types) ? selectedAssignment.submission_types.join(', ') : selectedAssignment.submission_types}</div>}
            </div>
          </div>
        );
      }

      if (selectedCourse) {
        return (
          <div className="p-4">
            <div className="flex justify-between items-center mb-4">
              <button className="flex items-center gap-1 text-blue-600" onClick={() => { setSelectedCourse(null); setAssignments([]); }}><ArrowLeft /> Courses</button>
              <button className="flex items-center gap-1 text-red-600" onClick={handleLogout}><LogOut /> Logout</button>
            </div>

            <h2 className="text-2xl font-semibold mb-2">{selectedCourse.name}</h2>
            {error && <div className="text-red-600 mb-2">{error}</div>}

            <div className="bg-white rounded shadow p-3">
              <h3 className="font-medium mb-2">Assignments</h3>
              {assignments.length === 0 ? (
                <div className="text-sm text-gray-600">No assignments or you do not have access.</div>
              ) : (
                <ul className="divide-y">
                  {assignments.map(a => (
                    <li key={a.id} className="p-3 hover:bg-gray-50 cursor-pointer" onClick={() => openAssignment(a)}>
                      <div className="flex justify-between">
                        <div>{a.name}</div>
                        <div className="text-xs text-gray-500">{a.due_at ? new Date(a.due_at).toLocaleDateString() : ''}</div>
                      </div>
                      {(!a.description && !a.__detailFetchFailed) && <div className="text-xs text-gray-400">Fetching details...</div>}
                      {a.__detailFetchFailed && <div className="text-xs text-red-400">Detail fetch failed. Click to open in Canvas.</div>}
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        );
      }

      return (
        <div className="p-4">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-semibold flex items-center gap-2"><BookOpen /> Courses</h1>
            <div className="flex items-center gap-2">
              <button className="text-sm text-gray-600" onClick={fetchCourses}>Refresh</button>
              <button className="text-red-600" onClick={handleLogout}><LogOut /> Logout</button>
            </div>
          </div>

          {error && <div className="text-red-600 mb-2">{error}</div>}

          <div className="bg-white rounded shadow p-3">
            <ul className="divide-y">
              {courses.map(c => (
                <li key={c.id} className="p-3 hover:bg-gray-50 cursor-pointer" onClick={() => selectCourse(c)}>
                  <div className="flex justify-between">
                    <div>{c.name}</div>
                    <div className="text-xs text-gray-500">{c.course_code || ''}</div>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<CanvasLite />);
  </script>
</body>
</html>
